"""Extract data from pdf files."""

# Todo:
# - malformed?


from pathlib import Path
from typing import List

from pypdf import PdfReader

from malwaredoc.data.base import Base
from malwaredoc.data.types import HexBytes


class ImageData(Base):
    name: str
    data: HexBytes


def extract_images_from_pdf(path: Path) -> List[ImageData]:
    """Extract image data from pdf

    Args:
        path (Path): path to pdf.

    Returns:
        ImageData: image data.
    """
    reader = PdfReader(path)

    images = []
    try:
        for page in reader.pages:
            images.extend(iter(page.images))
    except Exception as e:
        print(f"Failed to extract image data from pdf: {path}, due to:\n{str(e)}")

    return [ImageData(name=image.name, data=image.data) for image in images]


class AttachmentData(Base):
    name: str
    data: List[HexBytes]


def extract_attachments_from_pdf(path: Path) -> List[AttachmentData]:
    """Extract attachments from pdf file.

    Args:
        path (Path): path to pdf file.

    Returns:
        AttachmentData: attachment details.
    """
    reader = PdfReader(path)
    return [
        AttachmentData(name=name, data=content_list)
        for name, content_list in reader.attachments.items()
    ]


def extract_text_from_pdf(path: Path) -> str:
    """Extract all text from pdf file.

    Args:
        path (Path): path to pdf.

    Returns:
        str: text content.
    """
    reader = PdfReader(path)
    return "".join(page.extract_text() for page in reader.pages)
